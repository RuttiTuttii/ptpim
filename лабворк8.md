Я помогу вам создать приложение C# для организации доступа к БД с использованием Dapper и паттерна репозиторий согласно вашей лабораторной работе.

Структура проекта

```
Project/
├── Models/
│   ├── Visitor.cs
│   └── Genre.cs
├── Repositories/
│   ├── IRepository.cs
│   ├── VisitorRepository.cs
│   └── GenreRepository.cs
├── Data/
│   └── DatabaseContext.cs
└── Program.cs
```

Реализация

1. DatabaseContext

```csharp
// Data/DatabaseContext.cs
using System.Data;
using System.Data.SqlClient;

public class DatabaseContext
{
    private readonly string _connectionString;

    public DatabaseContext(string server, string database, string login, string password)
    {
        _connectionString = $"Server={server};Database={database};User Id={login};Password={password};TrustServerCertificate=true;";
    }

    public IDbConnection CreateConnection() => new SqlConnection(_connectionString);
}
```

2. Модели данных

```csharp
// Models/Genre.cs
public class Genre
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
}
```

```csharp
// Models/Visitor.cs
public class Visitor
{
    public int Id { get; set; }
    public string FirstName { get; set; } = string.Empty;
    public string LastName { get; set; } = string.Empty;
    public string? Email { get; set; }
    public string? Phone { get; set; }
    public DateTime RegistrationDate { get; set; }
}
```

3. Интерфейс репозитория

```csharp
// Repositories/IRepository.cs
public interface IRepository<T> where T : class
{
    Task<T?> GetByIdAsync(int id);
    Task<IEnumerable<T>> GetAllAsync();
    Task<int> AddAsync(T entity);
    Task UpdateAsync(T entity);
    Task DeleteAsync(int id);
}
```

4. Репозиторий для Genre

```csharp
// Repositories/GenreRepository.cs
using Dapper;
using System.Data;

public class GenreRepository : IRepository<Genre>
{
    private readonly DatabaseContext _dbContext;

    public GenreRepository(DatabaseContext dbContext)
    {
        _dbContext = dbContext;
    }

    public async Task<Genre?> GetByIdAsync(int id)
    {
        using var connection = _dbContext.CreateConnection();
        var sql = "SELECT * FROM Genre WHERE Id = @Id";
        return await connection.QuerySingleOrDefaultAsync<Genre>(sql, new { Id = id });
    }

    public async Task<IEnumerable<Genre>> GetAllAsync()
    {
        using var connection = _dbContext.CreateConnection();
        var sql = "SELECT * FROM Genre";
        return await connection.QueryAsync<Genre>(sql);
    }

    public async Task<int> AddAsync(Genre entity)
    {
        using var connection = _dbContext.CreateConnection();
        var sql = "INSERT INTO Genre (Name) OUTPUT INSERTED.Id VALUES (@Name)";
        return await connection.ExecuteScalarAsync<int>(sql, entity);
    }

    public async Task UpdateAsync(Genre entity)
    {
        using var connection = _dbContext.CreateConnection();
        var sql = "UPDATE Genre SET Name = @Name WHERE Id = @Id";
        await connection.ExecuteAsync(sql, entity);
    }

    public async Task DeleteAsync(int id)
    {
        using var connection = _dbContext.CreateConnection();
        var sql = "DELETE FROM Genre WHERE Id = @Id";
        await connection.ExecuteAsync(sql, new { Id = id });
    }
}
```

5. Репозиторий для Visitor

```csharp
// Repositories/VisitorRepository.cs
using Dapper;
using System.Data;

public class VisitorRepository : IRepository<Visitor>
{
    private readonly DatabaseContext _dbContext;

    public VisitorRepository(DatabaseContext dbContext)
    {
        _dbContext = dbContext;
    }

    public async Task<Visitor?> GetByIdAsync(int id)
    {
        using var connection = _dbContext.CreateConnection();
        var sql = "SELECT * FROM Visitor WHERE Id = @Id";
        return await connection.QuerySingleOrDefaultAsync<Visitor>(sql, new { Id = id });
    }

    public async Task<IEnumerable<Visitor>> GetAllAsync()
    {
        using var connection = _dbContext.CreateConnection();
        var sql = "SELECT * FROM Visitor";
        return await connection.QueryAsync<Visitor>(sql);
    }

    public async Task<int> AddAsync(Visitor entity)
    {
        using var connection = _dbContext.CreateConnection();
        var sql = @"INSERT INTO Visitor (FirstName, LastName, Email, Phone, RegistrationDate) 
                   OUTPUT INSERTED.Id 
                   VALUES (@FirstName, @LastName, @Email, @Phone, @RegistrationDate)";
        return await connection.ExecuteScalarAsync<int>(sql, entity);
    }

    public async Task UpdateAsync(Visitor entity)
    {
        using var connection = _dbContext.CreateConnection();
        var sql = @"UPDATE Visitor 
                   SET FirstName = @FirstName, LastName = @LastName, Email = @Email, 
                       Phone = @Phone, RegistrationDate = @RegistrationDate 
                   WHERE Id = @Id";
        await connection.ExecuteAsync(sql, entity);
    }

    public async Task DeleteAsync(int id)
    {
        using var connection = _dbContext.CreateConnection();
        var sql = "DELETE FROM Visitor WHERE Id = @Id";
        await connection.ExecuteAsync(sql, new { Id = id });
    }
}
```

6. Основное приложение

```csharp
// Program.cs
using System;
using System.Threading.Tasks;

class Program
{
    static async Task Main(string[] args)
    {
        try
        {
            // Создание контекста БД
            var dbContext = new DatabaseContext("localhost", "MyDatabase", "sa", "password");
            
            // Проверка подключения
            using (var connection = dbContext.CreateConnection())
            {
                await connection.OpenAsync();
                Console.WriteLine("Подключение к БД успешно установлено");
                await connection.CloseAsync();
            }

            // Создание репозиториев
            var genreRepository = new GenreRepository(dbContext);
            var visitorRepository = new VisitorRepository(dbContext);

            // Тестирование методов
            await TestGenreRepository(genreRepository);
            await TestVisitorRepository(visitorRepository);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка: {ex.Message}");
        }
    }

    static async Task TestGenreRepository(GenreRepository repository)
    {
        try
        {
            Console.WriteLine("\n--- Тестирование репозитория Genre ---");
            
            // Добавление жанра
            var newGenre = new Genre { Name = "Фантастика" };
            var genreId = await repository.AddAsync(newGenre);
            Console.WriteLine($"Добавлен жанр с ID: {genreId}");

            // Получение жанра по ID
            var genre = await repository.GetByIdAsync(genreId);
            if (genre != null)
                Console.WriteLine($"Получен жанр: {genre.Name}");

            // Получение всех жанров
            var allGenres = await repository.GetAllAsync();
            Console.WriteLine($"Всего жанров: {allGenres.Count()}");

            // Обновление жанра
            if (genre != null)
            {
                genre.Name = "Научная фантастика";
                await repository.UpdateAsync(genre);
                Console.WriteLine("Жанр обновлен");
            }

            // Удаление жанра
            await repository.DeleteAsync(genreId);
            Console.WriteLine("Жанр удален");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка при работе с Genre: {ex.Message}");
        }
    }

    static async Task TestVisitorRepository(VisitorRepository repository)
    {
        try
        {
            Console.WriteLine("\n--- Тестирование репозитория Visitor ---");
            
            // Добавление посетителя
            var newVisitor = new Visitor 
            { 
                FirstName = "Иван",
                LastName = "Иванов",
                Email = "ivan@example.com",
                Phone = "+79991234567",
                RegistrationDate = DateTime.Now
            };
            var visitorId = await repository.AddAsync(newVisitor);
            Console.WriteLine($"Добавлен посетитель с ID: {visitorId}");

            // Получение посетителя по ID
            var visitor = await repository.GetByIdAsync(visitorId);
            if (visitor != null)
                Console.WriteLine($"Получен посетитель: {visitor.FirstName} {visitor.LastName}");

            // Получение всех посетителей
            var allVisitors = await repository.GetAllAsync();
            Console.WriteLine($"Всего посетителей: {allVisitors.Count()}");

            // Обновление посетителя
            if (visitor != null)
            {
                visitor.FirstName = "Петр";
                await repository.UpdateAsync(visitor);
                Console.WriteLine("Посетитель обновлен");
            }

            // Удаление посетителя
            await repository.DeleteAsync(visitorId);
            Console.WriteLine("Посетитель удален");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка при работе с Visitor: {ex.Message}");
        }
    }
}
```

Ответы на контрольные вопросы

6.1 Что такое Dapper и для чего используется?

Dapper - это микро-ORM (Object-Relational Mapper), который предоставляет простые методы для выполнения SQL-запросов и отображения результатов на объекты C#. Он используется для упрощения доступа к базам данных и повышения производительности по сравнению с Entity Framework.

6.2 Какие методы Dapper позволяют извлечь данные из БД?

· Query<T> - для выполнения запросов, возвращающих множественные результаты
· QueryFirst<T>, QueryFirstOrDefault<T> - для возврата первой записи
· QuerySingle<T>, QuerySingleOrDefault<T> - для возврата единственной записи
· QueryMultiple - для выполнения нескольких запросов в одном вызове

6.3 Какие методы Dapper позволяют изменить данные в БД?

· Execute - для выполнения команд INSERT, UPDATE, DELETE
· ExecuteScalar - для выполнения команд, возвращающих одно значение
· ExecuteReader - для выполнения команд, возвращающих DataReader

6.4 Зачем используется паттерн «репозиторий»?

Паттерн репозиторий используется для:

· Инкапсуляции логики доступа к данным
· Разделения бизнес-логики и логики доступа к данным
· Упрощения тестирования (можно использовать mock-репозитории)
· Централизации операций CRUD
· Упрощения смены источника данных

Необходимые пакеты NuGet

Добавьте в проект через Package Manager Console:

```bash
Install-Package Dapper
Install-Package System.Data.SqlClient
```

Этот код полностью соответствует требованиям вашей лабораторной работы и демонстрирует все необходимые аспекты работы с Dapper и паттерном репозиторий.